########################################################################
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0
########################################################################
AWSTemplateFormatVersion: 2010-09-09
Description: This template creates a SSM Patch management solution within an AWS Organization

Metadata:
  SRA:
    Version: 1.0
    Entry: Parameters for deploying the solution resolving SSM parameters
    Order: 1
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Properties
        Parameters:
          - pSRASolutionName
          - pSRASolutionVersion
          - pSRAStagingS3BucketName
          - pSRAAlarmEmail
          - pAuditAccountId
          - pRootOrganizationalUnitId
          - pOrganizationId

      - Label:
          default: Custom Resource Properties
        Parameters:
          - pControlTowerRegionsOnly
          - pEnabledRegions

      - Label:
          default: General Lambda Function Properties
        Parameters:
          - pCreateLambdaLogGroup
          - pLambdaLogGroupRetention
          - pLambdaLogGroupKmsKey
          - pLambdaLogLevel

      - Label:
          default: EventBridge Rule Properties
        Parameters:
          - pControlTowerLifeCycleRuleName
          - pComplianceFrequency

    ParameterLabels:
      pAuditAccountId:
        default: Audit Account ID
      pComplianceFrequency:
        default: Frequency to Check for Organizational Compliance
      pControlTowerLifeCycleRuleName:
        default: Control Tower Lifecycle Rule Name
      pControlTowerRegionsOnly:
        default: Control Tower Regions Only
      pCreateLambdaLogGroup:
        default: Create Lambda Log Group
      pEnabledRegions:
        default: (Optional) Enabled Regions
      pLambdaLogGroupKmsKey:
        default: (Optional) Lambda Logs KMS Key
      pLambdaLogGroupRetention:
        default: Lambda Log Group Retention
      pLambdaLogLevel:
        default: Lambda Log Level
      pOrganizationId:
        default: Organization ID
      pRootOrganizationalUnitId:
        default: Root Organizational Unit ID
      pSRAAlarmEmail:
        default: (Optional) SRA Alarm Email
      pSRASolutionName:
        default: SRA Solution Name
      pSRASolutionVersion:
        default: SRA Solution Version
      pSRAStagingS3BucketName:
        default: SRA Staging S3 Bucket Name
      pPatchMgmtMaintWindowName:
        default: Patch Management Maintenance Window Name
      pPatchMgmtMaintWindowDesc:
        default: Patch Management Maintenance Window Description
      pPatchMgmtMaintWindowSchedule:
        default: Patch Management Maintenance Window Schedule
      pPatchMgmtMaintWindowDuration:
        default: Patch Management Maintenance Window Duration
      pPatchMgmtMaintWindowCutoff:
        default: Patch Management Maintenance Window Cutoff
      pPatchMgmtMaintWindowTZ:
        default: Patch Management Maintenance Window Timezone
      pPatchMgmtTaskName:
        default: Patch Management Task Name
      pPatchMgmtTaskDesc:
        default: Patch Management Task Description
      pPatchMgmtTaskRunCmd:
        default: Patch Management Task Run Command
      pPatchMgmtTargetName:
        default: Patch Management Target Name
      pPatchMgmtTargetDesc:
        default: Patch Management Target Description
      pPatchMgmtTargetValue1:
        default: Patch Management Target Value 1
      pPatchMgmtTargetValue2:
        default: Patch Management Target Value 2

Parameters:
  pAuditAccountId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription: Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/audit-account-id
    Description: SSM Parameter for AWS Account ID of the Control Tower account to delegate administration.
    Type: AWS::SSM::Parameter::Value<String>
  pControlTowerRegionsOnly:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Only enable in the Control Tower governed regions
    Type: String
  pCreateLambdaLogGroup:
    AllowedValues: ["true", "false"]
    Default: "false"
    Description:
      Indicates whether a CloudWatch Log Group should be explicitly created for the Lambda function, to allow for setting a Log Retention and/or KMS
      Key for encryption.
    Type: String
  pEnabledRegions:
    AllowedPattern: "^$|^([a-z0-9-]{1,64})$|^(([a-z0-9-]{1,64},)*[a-z0-9-]{1,64})$"
    ConstraintDescription:
      Only lowercase letters, numbers, and hyphens ('-') allowed. (e.g. us-east-1) Additional AWS regions can be provided, separated by commas. (e.g.
      us-east-1,ap-southeast-2)
    Default: ""
    Description: (Optional) Enabled regions (AWS regions, separated by commas). Leave blank to enable all regions.
    Type: String
  pPatchMgmtRoleName:
    AllowedValues: ["sra-patch-mgmt-configuration"]
    Default: "sra-patch-mgmt-configuration"
    Description: Patch Management Role Name
    Type: String
  pLambdaLogGroupKmsKey:
    AllowedPattern: '^$|^arn:(aws[a-zA-Z-]*){1}:kms:[a-z0-9-]+:\d{12}:key\/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$'
    ConstraintDescription: "Key ARN example:  arn:aws:kms:us-east-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab"
    Default: ""
    Description:
      (Optional) KMS Key ARN to use for encrypting the Lambda logs data. If empty, encryption is enabled with CloudWatch Logs managing the server-side
      encryption keys.
    Type: String
  pLambdaLogGroupRetention:
    AllowedValues:
      [
        1,
        3,
        5,
        7,
        14,
        30,
        60,
        90,
        120,
        150,
        180,
        365,
        400,
        545,
        731,
        1827,
        3653,
      ]
    Default: 14
    Description: Specifies the number of days you want to retain log events
    Type: String
  pLambdaLogLevel:
    AllowedValues: [INFO, ERROR, DEBUG]
    Default: INFO
    Description: Lambda Function Logging Level
    Type: String
  pOrganizationId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription: Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/organization-id
    Description: SSM Parameter for AWS Organizations ID
    Type: AWS::SSM::Parameter::Value<String>
  pRootOrganizationalUnitId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription: Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/root-organizational-unit-id
    Description: SSM Parameter for Root Organizational Unit ID
    Type: AWS::SSM::Parameter::Value<String>
  pSRAAlarmEmail:
    AllowedPattern: '^$|^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)$'
    ConstraintDescription: Must be a valid email address.
    Default: ""
    Description: (Optional) Email address for receiving SRA alarms
    Type: String
  pSRASolutionName:
    AllowedValues: [sra-patch-mgmt]
    Default: sra-patch-mgmt
    Description: The SRA solution name. The default value is the folder name of the solution
    Type: String
  pSRAStagingS3BucketName:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription: Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/staging-s3-bucket-name
    Description:
      SSM Parameter for SRA Staging S3 bucket name for the artifacts relevant to solution. (e.g., lambda zips, CloudFormation templates) S3 bucket
      name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: AWS::SSM::Parameter::Value<String>
  pSRASolutionVersion:
    AllowedValues: [v1.0]
    Default: v1.0
    Description: The SRA solution version. Used to trigger updates on the nested StackSets.
    Type: String
  pPatchMgmtMaintWindowName:
    Description: Patch Management Maintenance Window Name
    Default: Update_SSM
    Type: String
  pPatchMgmtMaintWindowDesc:
    Description: Patch Management Maintenance Window Description
    Default: Maintenance Window update the SSM Agent on managed Instances
    Type: String
  pPatchMgmtMaintWindowSchedule:
    Description: Patch Management Maintenance Window Description
    Default: "cron(0 0 1 ? * THU *)"
    Type: String
  pPatchMgmtMaintWindowDuration:
    Description: Patch Management Maintenance Window Duration
    Default: 6
    Type: Number
  pPatchMgmtMaintWindowCutoff:
    Description: Patch Management Maintenance Window Cutoff
    Default: 1
    Type: Number
  pPatchMgmtMaintWindowTZ:
    Description: Patch Management Maintenance Window Timezone
    Default: America/New_York
    Type: String
  pPatchMgmtTaskName:
    Description: Patch Management Task Name
    Type: String
    Default: Update_SSMAgent
  pPatchMgmtTaskDesc:
    Description: Patch Management Task Description
    Default: Task to update SSM Agent
    Type: String
  pPatchMgmtTaskRunCmd:
    Description: Patch Management Task Run Command
    Default: AWS-UpdateSSMAgent
    Type: String
  pPatchMgmtTargetName:
    Description: Patch Management Target Name
    Default: AWS-UpdateSSMAgent
    Type: String
  pPatchMgmtTargetDesc:
    Description: Patch Management Target Description
    Default: Maintenance Window to update SSM Agent
    Type: String
  pPatchMgmtTargetValue1:
    Description: Patch Management Target Value 1
    Default: Linux
    Type: String
  pPatchMgmtTargetValue2:
    Description: Patch Management Target Value 2
    Default: Windows
    Type: String

Resources:
  rpatchmgmtConfigurationIAMRoleStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: sra-patchmgmt-configuration-role
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: !Sub ${pSRASolutionVersion} - Deploys an IAM role via ${pSRASolutionName} for configuring SSM across regions and accounts.
      OperationPreferences:
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref pRootOrganizationalUnitId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-patch_mgmt-configuration-role.yaml
      Parameters:
        - ParameterKey: pManagementAccountId
          ParameterValue: !Ref AWS::AccountId
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName

  rpatchmgmtConfigurationIAMRoleStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-patch_mgmt-configuration-role.yaml
      Parameters:
        pManagementAccountId: !Ref AWS::AccountId
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  rpatchmgmtConfigurationStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - rpatchmgmtConfigurationIAMRoleStackSet
      - rpatchmgmtConfigurationIAMRoleStack
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-patch_mgmt-configuration.yaml
      Parameters:
        pControlTowerRegionsOnly: !Ref pControlTowerRegionsOnly
        pCreateLambdaLogGroup: !Ref pCreateLambdaLogGroup
        pEnabledRegions: !Ref pEnabledRegions
        pPatchMgmtRoleName: !Ref pPatchMgmtRoleName
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pOrganizationId: !Ref pOrganizationId
        pSRAAlarmEmail: !Ref pSRAAlarmEmail
        pSRAStagingS3BucketName: !Ref pSRAStagingS3BucketName
        pPatchMgmtMaintWindowName: !Ref pPatchMgmtMaintWindowName
        pPatchMgmtMaintWindowDesc: !Ref pPatchMgmtMaintWindowDesc
        pPatchMgmtMaintWindowSchedule: !Ref pPatchMgmtMaintWindowSchedule
        pDelegatedAdminAccountId: !Ref pAuditAccountId
        pPatchMgmtMaintWindowDuration: !Ref pPatchMgmtMaintWindowDuration
        pPatchMgmtMaintWindowCutoff: !Ref pPatchMgmtMaintWindowCutoff
        pPatchMgmtMaintWindowTZ: !Ref pPatchMgmtMaintWindowTZ
        pPatchMgmtTaskName: !Ref pPatchMgmtTaskName
        pPatchMgmtTaskDesc: !Ref pPatchMgmtTaskDesc
        pPatchMgmtTaskRunCmd: !Ref pPatchMgmtTaskRunCmd
        pPatchMgmtTargetName: !Ref pPatchMgmtTargetName
        pPatchMgmtTargetDesc: !Ref pPatchMgmtTargetDesc
        pPatchMgmtTargetValue1: !Ref pPatchMgmtTargetValue1
        pPatchMgmtTargetValue2: !Ref pPatchMgmtTargetValue2
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
